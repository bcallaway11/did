<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Writing Extensions to the did Package • did</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Writing Extensions to the did Package">
<meta property="og:description" content="did">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">did</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.1.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/index.html">User Guides</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/bcallaway11/did/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Writing Extensions to the did Package</h1>
                        <h4 data-toc-skip class="author">Brantly
Callaway and Pedro H.C. Sant’Anna</h4>
            
            <h4 data-toc-skip class="date">2023-08-29</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/bcallaway11/did/blob/HEAD/vignettes/extensions.Rmd" class="external-link"><code>vignettes/extensions.Rmd</code></a></small>
      <div class="hidden name"><code>extensions.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette provides an example of extending the ideas of the
<strong>did</strong> package to some other cases.</p>
<ul>
<li><p>We see the central idea of our approach to DiD to be for
researchers to carefully make the comparisons that they want to make. It
can be tricky to operationalize this though. And our code does not come
close to covering all possible cases where one would like for
identification to hold under some type of parallel trends
assumption.</p></li>
<li><p>In this vignette, we demonstrate how to do difference in
differences when individuals anticipate participating in the treatment
and potentially adjust their behavior before they participate.</p></li>
<li><p>Although we now allow for treatment anticipation in the
<strong>did</strong> package using the <code>anticipation</code>
argument, we still think that it is helpful to show a simplified version
of the code behind the <strong>did</strong> package so that researchers
can potentially borrow/modify it for one-off DiD applications that do
not conform exactly to the expected setup in the <strong>did</strong>
package. You will see that it’s not too complicated!</p></li>
<li><p>For this vignette, there’s some math. The notation may be
self-explanatory, but see our <a href="multi-period-did.html">Introduction to DiD with Multiple Time
Periods</a> for precise explanations of the notation.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="did-with-anticipation">DiD with Anticipation<a class="anchor" aria-label="anchor" href="#did-with-anticipation"></a>
</h2>
<p>The example we give next is one where individuals
<strong>anticipate</strong> participating in the treatment and adjust
their behavior (or at least their outcomes change) before they actually
participate in the treatment. This is a feature of some applications in
economics – for example, in labor applications such as job training or
job displacement, individual’s earnings often “dip” just before they
actually participate in the treatment. One solution to this is to impose
that parallel trends holds, but adjust the periods over which it holds.
One version of this is to make the assumption that</p>
<p><strong>Parallel Trends with Anticipation</strong> For all groups and
time periods such that <span class="math inline">\(t \ge g-1\)</span>
<span class="math display">\[
  E[Y_t(0) - Y_{g-2}(0) | G=g] = E[Y_t(0) - Y_{g-2}(0) | C=1]
\]</span></p>
<p>In other words, the path of outcomes, in the absence of participating
in the treatment, between periods <span class="math inline">\((g-2)\)</span> and <span class="math inline">\(t\)</span> is the same for individuals in group
<span class="math inline">\(g\)</span> (which is not observed) as for
untreated individuals (which is observed).</p>
<p>In this case, it is straightforward to show that, for all <span class="math inline">\(t \ge g-1\)</span>, <span class="math display">\[
  ATT(g,t) = E[Y_t - Y_{g-2} | G=g] - E[Y_t - Y_{g-2} | C=1]
\]</span></p>
<p>This is very similar to the main case covered in the
<strong>did</strong> package (see discussion in our <a href="multi-period-did.html">Introduction to DiD with Multiple Time
Periods</a> vignette), except that the “base period” here is <span class="math inline">\((g-2)\)</span> (two periods before individuals in
group <span class="math inline">\(g\)</span> become treated) rather than
<span class="math inline">\((g-1)\)</span> (one period before
individuals in group <span class="math inline">\(g\)</span> become
treated) which is the setup used in the <strong>did</strong>
package.</p>
<p>If you are worried that that units anticipate treatment participation
two periods before treatment actually starts, you could address this by
setting the base period to be <span class="math inline">\((g-3)\)</span>
instead. It is worth pointing out, however, that there is a tradeoff.
Allowing for more periods of anticipation will require that the parallel
trends assumption hold over more periods in order to identify the
group-time average treatment effects. At any rate, for this vignette, we
stick with the case where a researcher wants to allow anticipation
exactly one period before units participate in the treatment.</p>
<div class="section level3">
<h3 id="computing-treatment-effects-under-did-with-anticipation">Computing Treatment Effects under DiD with Anticipation<a class="anchor" aria-label="anchor" href="#computing-treatment-effects-under-did-with-anticipation"></a>
</h3>
<p>To start with, we want to point out that the important part for this
vignette is not so much this particular application, but rather just to
demonstrate how to write the code for this particular case.</p>
<ul>
<li><p>The code below should be instructive for extending these sorts of
ideas to other cases that may show up in applications.</p></li>
<li><p>We’ll write a simplified version of the code – it will not be as
fast as the code in the <strong>did</strong> package, but it will
demonstrate that it is relatively straightforward to write the code for
modified versions of our approach. [BTW, the code below is not too slow
either, basically things will run with a few thousand observations in a
couple minutes rather than a couple seconds.]</p></li>
</ul>
<p>To start with, we’ve constructed a dataset (called <code>dta</code>)
that has anticipation. All groups follow parallel trends (in the absence
of treatment) except in the period immediately before treatment (due to
treatment anticipation). In those periods, outcomes for individuals who
participate in the treatment “dip” – here, they decrease by 1 in the
pre-treatment period. In post-treatment periods, the effect of
participating in the treatment is equal to 1. This is simulated data,
but it has features that would be common in, for example, an application
evaluating the effect of a job training program.</p>
<p>Here is what the data looks like</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dta</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 35940</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dta</span><span class="op">)</span></span>
<span><span class="co">#&gt;       G          X id period        Y treat</span></span>
<span><span class="co">#&gt; 1     4 -0.9499532  1      1 4.152386     1</span></span>
<span><span class="co">#&gt; 8001  4 -0.9499532  1      2 3.675474     1</span></span>
<span><span class="co">#&gt; 16001 4 -0.9499532  1      3 1.502463     1</span></span>
<span><span class="co">#&gt; 24001 4 -0.9499532  1      4 2.588400     1</span></span>
<span><span class="co">#&gt; 32001 4 -0.9499532  1      5 1.538801     1</span></span>
<span><span class="co">#&gt; 2     3 -1.6527306  2      1 2.463654     1</span></span></code></pre></div>
<p>where <code>G</code> defines the period when an individual first
becomes treated, <code>X</code> is a covariate but we’ll ignore it
(parallel trends holds in this example without having to condition on
<code>X</code>), and <code>Y</code> is the outcome.</p>
<p>As a first step, we’ll try estimating the effect of participating in
the treatment (focus on dynamic effects as in an event study plot) while
just ignoring the possibility of anticipation.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># estimate group-time average treatment effects using att_gt method</span></span>
<span><span class="co"># (and ignoring pre-treatment "dip")</span></span>
<span><span class="va">attgt.ignoredip</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/att_gt.html">att_gt</a></span><span class="op">(</span>yname <span class="op">=</span> <span class="st">"Y"</span>,</span>
<span>                          tname <span class="op">=</span> <span class="st">"period"</span>,</span>
<span>                          idname <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>                          gname <span class="op">=</span> <span class="st">"G"</span>,</span>
<span>                          xformla <span class="op">=</span> <span class="op">~</span><span class="fl">1</span>,</span>
<span>                          data <span class="op">=</span> <span class="va">dta</span>,</span>
<span>                          <span class="op">)</span></span>
<span></span>
<span><span class="co"># summarize the results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">attgt.ignoredip</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; att_gt(yname = "Y", tname = "period", idname = "id", gname = "G", </span></span>
<span><span class="co">#&gt;     xformla = ~1, data = dta)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Reference: Callaway, Brantly and Pedro H.C. Sant'Anna.  "Difference-in-Differences with Multiple Time Periods." Journal of Econometrics, Vol. 225, No. 2, pp. 200-230, 2021. &lt;https://doi.org/10.1016/j.jeconom.2020.12.001&gt;, &lt;https://arxiv.org/abs/1803.09015&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Group-Time Average Treatment Effects:</span></span>
<span><span class="co">#&gt;  Group Time ATT(g,t) Std. Error [95% Simult.  Conf. Band]  </span></span>
<span><span class="co">#&gt;      3    2  -0.9867     0.0950       -1.2611     -0.7123 *</span></span>
<span><span class="co">#&gt;      3    3   1.9663     0.0663        1.7747      2.1579 *</span></span>
<span><span class="co">#&gt;      3    4   1.9931     0.0915        1.7285      2.2577 *</span></span>
<span><span class="co">#&gt;      3    5   2.0575     0.1218        1.7055      2.4094 *</span></span>
<span><span class="co">#&gt;      4    2   0.0267     0.0541       -0.1297      0.1831  </span></span>
<span><span class="co">#&gt;      4    3  -0.8470     0.1201       -1.1941     -0.4999 *</span></span>
<span><span class="co">#&gt;      4    4   1.9373     0.0635        1.7538      2.1208 *</span></span>
<span><span class="co">#&gt;      4    5   2.0648     0.0903        1.8040      2.3257 *</span></span>
<span><span class="co">#&gt;      5    2   0.0019     0.0586       -0.1673      0.1712  </span></span>
<span><span class="co">#&gt;      5    3   0.0115     0.0583       -0.1570      0.1800  </span></span>
<span><span class="co">#&gt;      5    4  -0.7937     0.1508       -1.2295     -0.3579 *</span></span>
<span><span class="co">#&gt;      5    5   2.1602     0.0676        1.9648      2.3555 *</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes: `*' confidence band does not cover 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; P-value for pre-test of parallel trends assumption:  0</span></span>
<span><span class="co">#&gt; Control Group:  Never Treated,  Anticipation Periods:  0</span></span>
<span><span class="co">#&gt; Estimation Method:  Doubly Robust</span></span>
<span></span>
<span><span class="co"># make dynamic effects plot</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ggdid.html">ggdid</a></span><span class="op">(</span><span class="fu"><a href="../reference/aggte.html">aggte</a></span><span class="op">(</span><span class="va">attgt.ignoredip</span>, <span class="st">"dynamic"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># add actual treatment effects to the plot</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="va">truth</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind.data.frame</a></span><span class="op">(</span>e <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>,<span class="fl">2</span><span class="op">)</span>, att.e <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">truth</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">e</span>, y <span class="op">=</span> <span class="va">att.e</span><span class="op">)</span>, inherit.aes <span class="op">=</span> <span class="cn">FALSE</span>, color <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">truth</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">e</span>, y <span class="op">=</span> <span class="va">att.e</span><span class="op">)</span>, inherit.aes <span class="op">=</span> <span class="cn">FALSE</span>, color <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span>
<span><span class="va">p</span></span></code></pre></div>
<p><img src="extensions_files/figure-html/unnamed-chunk-4-1.png" width="90%" style="display: block; margin: auto;"></p>
<p>In the figure, the blue line is the “truth”. You can see that
anticipation leads to two things. First, it leads to rejecting the
parallel trends assumptions – you can correctly visualize the
anticipation effects here and this is quite helpful for understanding
what is going on. Second, however, the anticipation effects feed into
the treatment effect estimates. Here, we over-estimate the effect of
participating in the treatment due to the anticipation. Also, note that
this example is really simple, and it would be easy to come up with
cases where the results were much more complicated by anticipation.</p>
<p>Next we want to write our own code for getting around anticipation. A
few notes:</p>
<ul>
<li><p>The goal here is to write a simple version of the code – it’s
possible to write faster code than what is given below, but there is a
trade-off between code running fast and the amount of time spent writing
it. If we were writing a one-off project that had anticipation, this is
how we’d do it. The way we implemented this feature to the
<strong>did</strong> package, on the other hand, is faster.</p></li>
<li><p>The code below is not (too much) optimized for <code>R</code>. We
have tried to write code that is easy to understand and (close to being)
portable to another programming language without too much
trouble.</p></li>
<li><p>Code below computes an event-study-type estimator, but we could
easily compute some other aggregation or look at group-time average
treatment effects if that’s what we wanted.</p></li>
</ul>
<p>Now to the code. We’ll start by writing a function to compute
group-time average treatment effects and dynamic effects given some
dataset (we’ll rely on the dataset having variables called
<code>G</code>, <code>id</code>, <code>period</code>, and
<code>Y</code>, but this would be easy to modify). Again, this function
is a simplified version of what’s going on behind the scenes in the
<strong>did</strong> package.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">compute.attgt</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dta</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># pick up all groups</span></span>
<span>  <span class="va">groups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">dta</span><span class="op">$</span><span class="va">G</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># pick up all time periods</span></span>
<span>  <span class="va">time.periods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">dta</span><span class="op">$</span><span class="va">period</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># sort the groups and drop the untreated group</span></span>
<span>  <span class="va">groups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">groups</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># sort the time periods and drop the first two</span></span>
<span>  <span class="co"># (can't compute treatment effects for these two</span></span>
<span>  <span class="co"># periods with one-period anticipation -- w/o anticipation</span></span>
<span>  <span class="co"># we would just drop one period here)</span></span>
<span>  <span class="va">time.periods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">time.periods</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># drop last time period (because we don't know if</span></span>
<span>  <span class="co"># these units are affected by anticipation or not</span></span>
<span>  <span class="co"># and we are being very careful)</span></span>
<span>  <span class="co"># (if you were worried about more than one anticipation</span></span>
<span>  <span class="co"># period here, would need to drop more time periods</span></span>
<span>  <span class="co"># from the end)</span></span>
<span>  <span class="va">time.periods</span> <span class="op">&lt;-</span> <span class="va">time.periods</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">time.periods</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># list to store all group-time average treatment effects</span></span>
<span>  <span class="co"># that we calculate</span></span>
<span>  <span class="va">attgt.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">counter</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span>  <span class="co"># loop over all groups</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">g</span> <span class="kw">in</span> <span class="va">groups</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="co"># get the correct "base" period for this group</span></span>
<span>    <span class="co"># (subtract 2 to avoid anticipation)</span></span>
<span>    <span class="va">main.base.period</span> <span class="op">&lt;-</span> <span class="va">g</span> <span class="op">-</span> <span class="fl">2</span></span>
<span>    </span>
<span>    <span class="co"># loop over all time periods</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">tp</span> <span class="kw">in</span> <span class="va">time.periods</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>      <span class="co">#----------------------------------------------------</span></span>
<span>      <span class="co"># if it's a pre-treatment time period (used for the</span></span>
<span>      <span class="co"># pre-test, we need to adjust the base period)</span></span>
<span></span>
<span>      <span class="co"># group not treated yet</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">tp</span> <span class="op">&lt;</span> <span class="va">g</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="co"># move two periods before</span></span>
<span>        <span class="va">base.period</span> <span class="op">&lt;-</span> <span class="va">tp</span> <span class="op">-</span> <span class="fl">2</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="co"># this is a post-treatment period</span></span>
<span>        <span class="va">base.period</span> <span class="op">&lt;-</span> <span class="va">main.base.period</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="co">#----------------------------------------------------</span></span>
<span></span>
<span>      <span class="co">#----------------------------------------------------</span></span>
<span>      <span class="co"># now, all we need to do is collect the right subset</span></span>
<span>      <span class="co"># of the data and estimate a 2x2 DiD</span></span>
<span></span>
<span>      <span class="co"># get group g and untreated group</span></span>
<span>      <span class="va">this.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">dta</span>, <span class="va">G</span><span class="op">==</span><span class="va">g</span> <span class="op">|</span> <span class="va">G</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span>      <span class="co"># get current period and base period data</span></span>
<span>      <span class="va">this.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">this.data</span>, <span class="va">period</span><span class="op">==</span><span class="va">tp</span> <span class="op">|</span> <span class="va">period</span><span class="op">==</span><span class="va">base.period</span><span class="op">)</span></span>
<span></span>
<span>      <span class="co"># set up to compute 2x2 estimator</span></span>
<span>      <span class="va">Ypost</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">this.data</span>, <span class="va">period</span><span class="op">==</span><span class="va">tp</span><span class="op">)</span><span class="op">$</span><span class="va">Y</span></span>
<span>      <span class="va">Ypre</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">this.data</span>, <span class="va">period</span><span class="op">==</span><span class="va">base.period</span><span class="op">)</span><span class="op">$</span><span class="va">Y</span></span>
<span></span>
<span>      <span class="co"># dummy variable being in group g</span></span>
<span>      <span class="va">G</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">this.data</span>, <span class="va">period</span><span class="op">==</span><span class="va">tp</span><span class="op">)</span><span class="op">$</span><span class="va">G</span> <span class="op">==</span> <span class="va">g</span><span class="op">)</span></span>
<span></span>
<span>      <span class="co"># compute 2x2 estimator using DRDID package</span></span>
<span>      <span class="co"># (in this unconditional case, it would be straightforward</span></span>
<span>      <span class="co"># to calculate the 2x2 att just using averages, but we</span></span>
<span>      <span class="co"># like the DRDID package as it will work for more complicated</span></span>
<span>      <span class="co"># cases as well)</span></span>
<span>      <span class="va">attgt</span> <span class="op">&lt;-</span> <span class="fu">DRDID</span><span class="fu">::</span><span class="fu"><a href="https://psantanna.com/DRDID/reference/reg_did_panel.html" class="external-link">reg_did_panel</a></span><span class="op">(</span><span class="va">Ypost</span>, <span class="va">Ypre</span>, <span class="va">G</span>, covariates<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">$</span><span class="va">ATT</span></span>
<span></span>
<span>      <span class="co"># save results</span></span>
<span>      <span class="va">attgt.list</span><span class="op">[[</span><span class="va">counter</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>att<span class="op">=</span><span class="va">attgt</span>, group<span class="op">=</span><span class="va">g</span>, time.period<span class="op">=</span><span class="va">tp</span><span class="op">)</span></span>
<span>      <span class="va">counter</span> <span class="op">&lt;-</span> <span class="va">counter</span><span class="op">+</span><span class="fl">1</span></span>
<span>      <span class="co">#----------------------------------------------------</span></span>
<span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co">#-----------------------------------------------------------------------------</span></span>
<span>  <span class="co"># aggregate into dynamic effects</span></span>
<span>  </span>
<span>  <span class="co"># turn results into a data.frame</span></span>
<span>  <span class="va">attgt.results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="st">"rbind.data.frame"</span>, <span class="va">attgt.list</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># add event time to the results</span></span>
<span>  <span class="va">attgt.results</span><span class="op">$</span><span class="va">e</span> <span class="op">&lt;-</span> <span class="va">attgt.results</span><span class="op">$</span><span class="va">time.period</span> <span class="op">-</span> <span class="va">attgt.results</span><span class="op">$</span><span class="va">group</span></span>
<span>  </span>
<span>  <span class="co"># calculate relative sizes of each group</span></span>
<span>  <span class="co"># (will be used as weights)</span></span>
<span>  <span class="va">n.group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">groups</span>, <span class="kw">function</span><span class="op">(</span><span class="va">gg</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">dta</span>, <span class="va">G</span><span class="op">==</span><span class="va">gg</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># merge in group sizes</span></span>
<span>  <span class="va">ngroup.mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">groups</span>, <span class="va">n.group</span><span class="op">)</span></span>
<span>  <span class="va">attgt.results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">attgt.results</span>, <span class="va">ngroup.mat</span>, by.x <span class="op">=</span> <span class="st">"group"</span>, by.y <span class="op">=</span> <span class="st">"groups"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># event times to calculate dynamic effects</span></span>
<span>  <span class="va">eseq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">attgt.results</span><span class="op">$</span><span class="va">e</span><span class="op">)</span> </span>
<span>  <span class="va">eseq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">eseq</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># calculate average effects by event time</span></span>
<span>  <span class="va">att.e</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">counter</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">this.e</span> <span class="kw">in</span> <span class="va">eseq</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># get subset of results at this event time</span></span>
<span>    <span class="va">res.e</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">attgt.results</span>, <span class="va">e</span><span class="op">==</span><span class="va">this.e</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># calculate weights by group size</span></span>
<span>    <span class="va">res.e</span><span class="op">$</span><span class="va">weight</span> <span class="op">&lt;-</span> <span class="va">res.e</span><span class="op">$</span><span class="va">n.group</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">res.e</span><span class="op">$</span><span class="va">n.group</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># calculate dynamic effect as weighted average</span></span>
<span>    <span class="va">att.e</span><span class="op">[</span><span class="va">counter</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">res.e</span><span class="op">$</span><span class="va">att</span> <span class="op">*</span> <span class="va">res.e</span><span class="op">$</span><span class="va">weight</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># on to the next one</span></span>
<span>    <span class="va">counter</span> <span class="op">&lt;-</span> <span class="va">counter</span><span class="op">+</span><span class="fl">1</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># store dynamic effects results</span></span>
<span>  <span class="va">dyn.results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind.data.frame</a></span><span class="op">(</span>e <span class="op">=</span> <span class="va">eseq</span>, att.e <span class="op">=</span> <span class="va">att.e</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># return group-time average treatment effects and dynamic effects</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>attgt.results<span class="op">=</span><span class="va">attgt.results</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"group"</span>,<span class="st">"att"</span>,<span class="st">"time.period"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>              dyn.results<span class="op">=</span><span class="va">dyn.results</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now, we have a function to compute group-time average treatment
effects and dynamic effects. Let’s use it on the data that we have</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">anticipation.results</span> <span class="op">&lt;-</span> <span class="fu">compute.attgt</span><span class="op">(</span><span class="va">dta</span><span class="op">)</span></span>
<span><span class="va">anticipation.results</span></span>
<span><span class="co">#&gt; $attgt.results</span></span>
<span><span class="co">#&gt;   group         att time.period</span></span>
<span><span class="co">#&gt; 1     3  0.97958850           3</span></span>
<span><span class="co">#&gt; 2     3  1.00638860           4</span></span>
<span><span class="co">#&gt; 3     4 -0.82029907           3</span></span>
<span><span class="co">#&gt; 4     4  1.09030729           4</span></span>
<span><span class="co">#&gt; 5     5  0.01348315           3</span></span>
<span><span class="co">#&gt; 6     5 -0.78216442           4</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $dyn.results</span></span>
<span><span class="co">#&gt;    e       att.e</span></span>
<span><span class="co">#&gt; 1 -2  0.01348315</span></span>
<span><span class="co">#&gt; 2 -1 -0.80112469</span></span>
<span><span class="co">#&gt; 3  0  1.03522713</span></span>
<span><span class="co">#&gt; 4  1  1.00638860</span></span></code></pre></div>
<p>Finally, let’s compute some standard errors using the nonparametric
bootstrap (which is different and much slower than the multiplier
bootstrap that we use in the <em>did</em> package); we’ll just focus on
the dynamic effects estimator</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># the number of bootstrap iterations</span></span>
<span><span class="va">biters</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span></span>
<span><span class="co"># list to store bootstrap results</span></span>
<span><span class="va">boot.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># loop for each nonparametric bootstrap iteration</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">b</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">biters</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># draw a bootstrap sample; here, we'll call an outside function</span></span>
<span>  <span class="va">bdata</span> <span class="op">&lt;-</span> <span class="fu">BMisc</span><span class="fu">::</span><span class="fu"><a href="https://bcallaway11.github.io/BMisc/reference/blockBootSample.html" class="external-link">blockBootSample</a></span><span class="op">(</span><span class="va">dta</span>, <span class="st">"id"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># call our function for estimating dynamic effects on the</span></span>
<span>  <span class="co"># bootstrapped data</span></span>
<span>  <span class="va">boot.res</span><span class="op">[[</span><span class="va">b</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">compute.attgt</span><span class="op">(</span><span class="va">bdata</span><span class="op">)</span><span class="op">$</span><span class="va">dyn.results</span><span class="op">$</span><span class="va">att.e</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># use the bootstrapped results to compute standard errors</span></span>
<span><span class="va">boot.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">simplify2array</a></span><span class="op">(</span><span class="va">boot.res</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">boot.se</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">boot.res</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># add the standard errors to the main results</span></span>
<span><span class="va">dyn.results</span> <span class="op">&lt;-</span> <span class="va">anticipation.results</span><span class="op">$</span><span class="va">dyn.results</span></span>
<span><span class="va">dyn.results</span><span class="op">$</span><span class="va">att.se</span> <span class="op">&lt;-</span> <span class="va">boot.se</span></span></code></pre></div>
<p>Finally, we can translate these into a plot. [One last thing here, to
keep things very simple, we are going to plot pointwise confidence
intervals, but we strongly suggest computing simultaneous confidence
bands in practice.]</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">dyn.results</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">e</span>, y<span class="op">=</span><span class="va">att.e</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_errorbar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin<span class="op">=</span><span class="op">(</span><span class="va">att.e</span><span class="op">-</span><span class="fl">1.96</span><span class="op">*</span><span class="va">att.se</span><span class="op">)</span>, ymax<span class="op">=</span><span class="op">(</span><span class="va">att.e</span><span class="op">+</span><span class="fl">1.96</span><span class="op">*</span><span class="va">att.se</span><span class="op">)</span><span class="op">)</span>, width<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">truth</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">e</span>, y<span class="op">=</span><span class="va">att.e</span><span class="op">)</span>, inherit.aes<span class="op">=</span><span class="cn">FALSE</span>, color<span class="op">=</span><span class="st">"blue"</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">truth</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">e</span>, y<span class="op">=</span><span class="va">att.e</span><span class="op">)</span>, inherit.aes<span class="op">=</span><span class="cn">FALSE</span>, color<span class="op">=</span><span class="st">"blue"</span><span class="op">)</span></span>
<span><span class="va">p</span></span></code></pre></div>
<p><img src="extensions_anticipation.png" style="width:90.0%"></p>
<p>Here, the black line is our estimate and the blue line is the
“truth”. You can immediately see that we get things right here when we
account for anticipation. The only other thing to notice is that we do
not estimate dynamic effects at as many different lengths of exposure,
but that is the price to pay for accounting for anticipation.</p>
</div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>In this vignette, we illustrated how one could apply the principles
in the <strong>did</strong> package to the case where units anticipate
participating in the treatment. This is a relatively straightforward
exercise, and we think that showing this sort of extension is
potentially useful for other situations that do not fit exactly into the
cases covered by the <strong>did</strong> package.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="https://bcallaway11.github.io/" class="external-link">Brantly Callaway</a>, <a href="https://pedrohcgs.github.io/" class="external-link">Pedro H. C. Sant’Anna</a>.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
